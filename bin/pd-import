#!/usr/bin/env php
<?php

use Commands\SyncRemoteDirsCommand;
use Config\Config;
use Symfony\Component\Console\Application;

function searchAndRequire($file, $maxDepth = 3) {
    $path = __DIR__ . DIRECTORY_SEPARATOR;
    for ($i = 0; $i <= $maxDepth; $i++) {
        if (file_exists($path.$file)) {
            require $path . $file;
            return;
        }
        $path .= '..' . DIRECTORY_SEPARATOR;
    }

    fwrite(STDERR, 'ERROR: The project is not set up properly! Please consult the README.' . PHP_EOL);
    exit(1);
}

searchAndRequire('vendor/autoload.php');
searchAndRequire('../bootstrap/init.php');

// init the DI container
$container = new Pimple\Container();
initContainer($container);

//check if there is a config file, otherwise create one first.
if (!file_exists(Config::getConfigFilePath())) {
    Config::createConfigFile();
    fprintf(STDOUT, "A configuration file template has been copied to %s.\nPlease review the configuration to make sure it can be used.\n", Config::getConfigFilePath());
    return;
}

/*
try {
    (new App($container))->run();
}catch(Exception $e) {
    fprintf(STDERR, "ERROR: %s\n", $e->getMessage());
}*/

$console = new Application();
$console->setName('Profildienst Import');

$console->add(new SyncRemoteDirsCommand($container['config']));

$console->run();